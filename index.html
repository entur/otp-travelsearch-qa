<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const BASE_URI = "http://otpreport-test.entur.org/otp-travelsearch-qa/reports"
    const INDEX_URI = BASE_URI + "/index"
    const SHAMASH_OTP = "https://api.entur.org/doc/shamash-otp/?query="
    const MAX_REPORTS = 20

    /**
    * This component should really use react-chartjs but that requires webpack or browserify
    **/
    class LineChartComponent extends React.Component {

      constructor(props) {
        super(props)
        this.state = { myChart: null, thisCanvas: null}
      }

      shouldComponentUpdate(nextProps, nextState) {
        const nextDates = nextProps.reports.map((report) => report.date)
        const currentDates = this.props.reports.map((report) => report.date)

        if(this.arraysEquals(currentDates, nextDates)) {
          return false
        }

        return true
      }

      arraysEquals(array1, array2) {
        if (array1.length != array2.length) return false
        for (var i = 0; i < array1.length; i++) {
            if (array1[i].compare) {
                if (!array1[i].compare(array2[i])) return false
            }
            else if (array1[i] !== array2[i]) return false
        }
        return true
      }

      componentWillUpdate(nextProps, nextState) {
        if(this.state.myChart != null) {
          this.state.myChart.destroy()
        }
        const myChart = this.createChart(nextProps.reports)
        this.setState({myChart: myChart})
      }

      componentDidMount() {
        if(this.thisCanvas != null) {
          this.setState({thisCanvas: this.thisCanvas})
        }
      }

      render() {
        return (<div><canvas id="lineChartId" width="200" height="200" ref={(input) => this.thisCanvas = input}></canvas></div>)
      }

      createChart(reports) {
        const ctx = this.thisCanvas.getContext('2d')
        const labels = reports.map((report) => report.date).reverse()
        const secondsAverage = reports.map((report) => report.secondsAverage).reverse()
        const secondsTotal = reports.map((report) => report.secondsTotal).reverse()
        const myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: labels,
              datasets: [{
                  id: "average",
                  label: 'Average seconds test execution',
                  data: secondsAverage,
                  borderWidth: 1,
                  backgroundColor: 'rgb(24, 28, 86)',
              },
              {
                  id: "total",
                  label: 'Seconds total',
                  data: secondsTotal,
                  borderWidth: 1,
                  backgroundColor: '#5AC39A',
              }
            ]
          },
          options: {
              maintainAspectRatio: false,
              scales: {
                  yAxes: [{
                      ticks: {
                          beginAtZero:true
                      }
                  }]
              },
              tooltips: {
                  enabled: false
              }
          }
        })
        return myChart
      }

    }

    class FailedSearch extends React.Component {

      render() {
        const failedSearch = this.props.failedSearch
        const shamashHref = SHAMASH_OTP + encodeURIComponent(failedSearch.otpQuery)

        return (
          <li>
            {failedSearch.search.name}:&nbsp;
            <a href={shamashHref} target="_blank" style={{color: "#5AC39A"}}>
               From {failedSearch.search.fromPlace} to {failedSearch.search.toPlace}
            </a>
          </li>
        )
      }
    }

    class Report extends React.Component {
      render() {
        const report = this.props.report
        const failedSearches = report.failedSearches.map((failedSearch, index) =>
          <FailedSearch key={index} failedSearch={failedSearch} />
        )

        return (
            <tr className="active">
              <td>{report.date}</td>
              <td>{report.failedPercentage.toFixed(2)}%>></td>
              <td>{report.numberOfSearches}</td>
              <td>{report.secondsTotal.toFixed(2)}</td>
              <td>{report.secondsAverage.toFixed(2)}</td>
              <td><ul>{failedSearches}</ul></td>
            </tr>
         )
      }
    }

    class Logo extends React.Component {
      render() {
        return (
          <div style={{width: "40px", float: "left"}}>
            <svg viewBox="0 0 62 19" id="logo" width="100%" height="100%">
                <title>Group</title>
                <desc>Created with Sketch.</desc>

                <g id="logo_Samlet" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="logo_Frontpage" transform="translate(-22.000000, -26.000000)">
                        <g id="logo_Group" transform="translate(22.000000, 26.000000)">
                            <g id="logo_Page-1">
                                <polygon id="logo_Fill-1" fill="#FFFFFF" points="0 2.79701758e-05 0 13.0062995 9.39157586 13.0062995 9.39157586 10.8030888 2.43940419 10.8030888 2.43940419 7.65812224 8.60751594 7.65812224 8.60751594 5.45491149 2.43940419 5.45491149 2.43940419 2.20323871 9.39157586 2.20323871 9.39157586 2.79701758e-05"></polygon>
                                <polygon id="logo_Fill-2" fill="#FF5959" points="0 18 22.9826792 18 22.9826792 16 0 16"></polygon>
                                <polygon id="logo_Fill-3" fill="#FFFFFF" points="20.5432065 2.79701758e-05 20.5432065 7.87125498 12.1621175 2.79701758e-05 11.9008556 2.79701758e-05 11.9008556 13.0062995 14.3401226 13.0062995 14.3401226 5.27716103 22.7217602 13.0062995 22.9827478 13.0062995 22.9827478 2.79701758e-05"></polygon>
                                <polygon id="logo_Fill-4" fill="#FFFFFF" points="35.4668962 7.657409 31.825276 7.657409 31.825276 18.4604698 29.3860089 18.4604698 29.3860089 7.657409 25.7266969 7.657409 25.7266969 5.45419825 35.4668962 5.45419825"></polygon>
                                <g id="logo_Group-9" transform="translate(37.303533, 5.405516)" fill="#FFFFFF">
                                    <path d="M5.56853974,13.2858335 C4.74361051,13.2858335 3.99438551,13.1553526 3.32086473,12.8949503 C2.64706967,12.6345479 2.07201925,12.2672995 1.59585063,11.7933449 C1.11954485,11.31967 0.75076103,10.7450227 0.489499154,10.0698227 C0.228100132,9.39462263 0.0972634763,8.64264445 0.0972634763,7.81318889 L0.0972634763,0.0486681058 L2.53680481,0.0486681058 L2.53680481,7.81318889 C2.53680481,8.46489399 2.64130957,9.00373942 2.85045621,9.43014475 C3.05946571,9.85655008 3.31784754,10.19429 3.62573883,10.4429448 C3.93349297,10.6917395 4.26456183,10.8636163 4.61908254,10.9581555 C4.97319181,11.053254 5.2898604,11.1003838 5.56853974,11.1003838 C5.84735622,11.1003838 6.16388767,11.053254 6.51840838,10.9581555 C6.87251765,10.8636163 7.2035865,10.6917395 7.51147779,10.4429448 C7.8190948,10.19429 8.07775091,9.85655008 8.28676041,9.43014475 C8.4960442,9.00373942 8.60041181,8.46489399 8.60041181,7.81318889 L8.60041181,0.0486681058 L11.0399531,0.0486681058 L11.0399531,7.81318889 C11.0399531,8.64264445 10.9119965,9.39462263 10.6566319,10.0698227 C10.4008559,10.7450227 10.0348149,11.31967 9.55878346,11.7933449 C9.08234054,12.2672995 8.50729012,12.6345479 7.83390649,12.8949503 C7.15997428,13.1553526 6.40512632,13.2858335 5.56853974,13.2858335" id="logo_Fill-5"></path>
                                    <path d="M16.2669461,6.74725948 L19.0459222,6.74725948 C19.5550057,6.74725948 19.9746704,6.68222882 20.3046421,6.55174795 C20.634751,6.42154678 20.8953271,6.24967005 21.0863706,6.03639746 C21.2775512,5.82326472 21.4077021,5.58342047 21.4770977,5.31686469 C21.5464932,5.05044877 21.5813281,4.78109598 21.5813281,4.50852661 C21.5813281,4.18868765 21.5320929,3.89262334 21.4338969,3.62005398 C21.3351522,3.34776432 21.1847038,3.11099678 20.982003,2.90933181 C20.7794393,2.7080864 20.5190003,2.54823685 20.2005488,2.42950345 C19.881823,2.31132946 19.4972675,2.25189283 19.0459222,2.25189283 L16.2669461,2.25189283 L16.2669461,6.74725948 Z M16.2669461,8.9149481 L16.2669461,13.0549537 L13.8275419,13.0549537 L13.8275419,0.0486820909 L19.6222069,0.0486820909 C20.2740587,0.0486820909 20.8702295,0.15832518 21.411405,0.377471507 C21.9524434,0.596757685 22.4150346,0.904569469 22.7989045,1.30132641 C23.1827743,1.69836306 23.4824368,2.17203798 23.6978922,2.72277074 C23.9129361,3.27364335 24.0207323,3.87486228 24.0207323,4.52628767 C24.0207323,5.01198978 23.9566854,5.48286768 23.828866,5.93878155 C23.7009094,6.39483526 23.5233062,6.80655625 23.2961935,7.17366481 C23.0692179,7.54091322 22.78999,7.85767546 22.4585097,8.12423123 C22.1270294,8.39078701 21.7631828,8.57734808 21.3675185,8.68391445 L24.5433932,13.0549537 L21.6337176,13.0549537 L18.6809784,8.9149481 L16.2669461,8.9149481 Z" id="logo_Fill-7"></path>
                                </g>
                            </g>
                        </g>
                    </g>
                </g>
            </svg>
          </div>
        )
      }
    }

    class ReportList extends React.Component {

        constructor(props) {
          super(props)
          this.state = { reportLocations: [], reports: [], intervalId: null}
        }

        fetchReports() {
          const self = this

          axios.get(INDEX_URI)
            .then(function (response) {
              let reportLines = response.data.split('\n')


              reportLines = reportLines.sort(function(a, b) {
                let aTimestamp = a.substring(a.lastIndexOf('-') + 1, a.lastIndexOf('.json'))
                let bTimestamp = b.substring(b.lastIndexOf('-') + 1, b.lastIndexOf('.json'))

                if(aTimestamp < bTimestamp) return 1
                if(aTimestamp > bTimestamp) return -1
                return 0;
              }).slice(0, MAX_REPORTS)
              .filter(reportLocation => {
                return self.state.reportLocations.indexOf(reportLocation) == -1
              })

              self.setState({reportLocations: [...self.state.reportLocations, ...reportLines]})

              let promiseArray = reportLines.map(reportLocation => axios.get(BASE_URI + "/" + reportLocation))
              axios.all(promiseArray).then((results) => {
                const newReports = []
                results.forEach(result => {
                  let found = false
                  self.state.reports.forEach((existingReport) => {
                    if(existingReport.date === result.data.date) {
                      found = true
                    }
                  })
                  if(!found) {
                    newReports.push(result.data)
                  }
                })
                self.setState({ reports: [...self.state.reports, ...newReports] })
              })
            })
        }

        componentDidMount() {
          var intervalId = setInterval(this.fetchReports.bind(this), 10000)
          this.setState({intervalId: intervalId})
          this.fetchReports()
        }

        componentWillUnmount() {
          clearInterval(this.state.intervalId)
        }

        render() {

          const reportComponents = this.state.reports.map((report) =>
             <Report key={new Date(report.date).getTime()} report={report}/>
          )
          return (
            <div>

              <div className="pt-3 pb-2 pl-3" style={{background: "rgb(24, 28, 86)", color:"white", height: "65px"}}>
                <Logo />
                <h2 style={{float: "left", position: "relative", marginLeft: "10px"}}>OTP Travel Search Reports</h2>
              </div>

             <table className="table table-hover table-condensed my-4 mx-4">
              <tbody>
                <tr>
                  <th>Date</th>
                  <th>Failed percentage</th>
                  <th>Number of searches</th>
                  <th>Seconds total</th>
                  <th>Seconds average</th>
                  <th>Failed searches</th>
                </tr>
                {reportComponents}
              </tbody>
              </table>
              <LineChartComponent reports={this.state.reports} />
             </div>
           )
        }
    }

    ReactDOM.render(
        <ReportList />,
        document.getElementById('root')
    )
  </script>
</html>
