<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const BASE_URI = "http://otpreport-test.entur.org/otp-travelsearch-qa/reports"
    const INDEX_URI = BASE_URI + "/index"
    const SHAMASH_OTP = "https://api.entur.org/doc/shamash-otp/?query="
    const MAX_REPORTS = 20

    /**
    * This component should really use react-chartjs but that requires webpack or browserify
    **/
    class LineChartComponent extends React.Component {

      constructor(props) {
        super(props)
        this.state = { myChart: null, thisCanvas: null}
      }

      shouldComponentUpdate(nextProps, nextState) {
        const nextDates = nextProps.reports.map((report) => report.date)
        const currentDates = this.props.reports.map((report) => report.date)

        if(this.arraysEquals(currentDates, nextDates)) {
          return false
        }

        return true
      }

      arraysEquals(array1, array2) {
        if (array1.length != array2.length) return false
        for (var i = 0; i < array1.length; i++) {
            if (array1[i].compare) {
                if (!array1[i].compare(array2[i])) return false
            }
            else if (array1[i] !== array2[i]) return false
        }
        return true
      }

      componentWillUpdate(nextProps, nextState) {
        if(this.state.myChart != null) {
          this.state.myChart.destroy()
        }
        const myChart = this.createChart(nextProps.reports)
        this.setState({myChart: myChart})
      }

      componentDidMount() {
        if(this.thisCanvas != null) {
          this.setState({thisCanvas: this.thisCanvas})
        }
      }

      render() {
        return (<div><canvas id="lineChartId" width="200" height="200" ref={(input) => this.thisCanvas = input}></canvas></div>)
      }

      createChart(reports) {
        const ctx = this.thisCanvas.getContext('2d')
        const labels = reports.map((report) => report.date).reverse()
        const secondsAverage = reports.map((report) => report.secondsAverage).reverse()
        const secondsTotal = reports.map((report) => report.secondsTotal).reverse()
        const myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: labels,
              datasets: [{
                  id: "average",
                  label: 'Average seconds test execution',
                  data: secondsAverage,
                  borderWidth: 1,
                  backgroundColor: 'rgb(255, 99, 132)',
              },
              {
                  id: "total",
                  label: 'Seconds total',
                  data: secondsTotal,
                  borderWidth: 1,
                  backgroundColor: 'navy',
              }
            ]
          },
          options: {
              maintainAspectRatio: false,
              scales: {
                  yAxes: [{
                      ticks: {
                          beginAtZero:true
                      }
                  }]
              },
              tooltips: {
                  enabled: false
              }
          }
        })
        return myChart
      }

    }

    class FailedSearch extends React.Component {

      render() {
        const failedSearch = this.props.failedSearch
        const shamashHref = SHAMASH_OTP + encodeURIComponent(failedSearch.otpQuery)

        return (
          <li>
            <a href={shamashHref} target="_blank">
              Search from {failedSearch.search.fromPlace} to {failedSearch.search.toPlace}
            </a>
          </li>
        )
      }
    }

    class Report extends React.Component {
      render() {
        const report = this.props.report
        const failedSearches = report.failedSearches.map((failedSearch, index) =>
          <FailedSearch key={index} failedSearch={failedSearch} />
        )

        return (
            <tr className="active">
              <td>{report.date}</td>
              <td>{report.failedPercentage}</td>
              <td>{report.numberOfSearches}</td>
              <td>{report.secondsTotal.toFixed(2)}</td>
              <td>{report.secondsAverage.toFixed(2)}</td>
              <td><ul>{failedSearches}</ul></td>
            </tr>
         )
      }
    }

    class ReportList extends React.Component {

        constructor(props) {
          super(props)
          this.state = { reportLocations: [], reports: [], intervalId: null}
        }

        fetchReports() {
          const self = this

          axios.get(INDEX_URI)
            .then(function (response) {
              let reportLines = response.data.split('\n')


              reportLines = reportLines.sort(function(a, b) {
                let aTimestamp = a.substring(a.lastIndexOf('-') + 1, a.lastIndexOf('.json'))
                let bTimestamp = b.substring(b.lastIndexOf('-') + 1, b.lastIndexOf('.json'))

                if(aTimestamp < bTimestamp) return 1
                if(aTimestamp > bTimestamp) return -1
                return 0;
              }).slice(0, MAX_REPORTS)
              .filter(reportLocation => {
                return self.state.reportLocations.indexOf(reportLocation) == -1
              })

              self.setState({reportLocations: [...self.state.reportLocations, ...reportLines]})

              let promiseArray = reportLines.map(reportLocation => axios.get(BASE_URI + "/" + reportLocation))
              axios.all(promiseArray).then((results) => {
                const newReports = []
                results.forEach(result => {
                  let found = false
                  self.state.reports.forEach((existingReport) => {
                    if(existingReport.date === result.data.date) {
                      found = true
                    }
                  })
                  if(!found) {
                    newReports.push(result.data)
                  }
                })
                self.setState({ reports: [...self.state.reports, ...newReports] })
              })
            })
        }

        componentDidMount() {
          var intervalId = setInterval(this.fetchReports.bind(this), 10000)
          this.setState({intervalId: intervalId})
          this.fetchReports()
        }

        componentWillUnmount() {
          clearInterval(this.state.intervalId)
        }

        render() {

          const reportComponents = this.state.reports.map((report) =>
             <Report key={new Date(report.date).getTime()} report={report}/>
          )
          return (
            <div>
             <h1>OTP Travel Search reports</h1>
             <table className="table table-striped table-hover table-condensed">
              <tbody>
                <tr>
                  <th>Date</th>
                  <th>Failed percentage</th>
                  <th>Number of searches</th>
                  <th>Seconds total</th>
                  <th>Seconds average</th>
                  <th>Failed searches</th>
                </tr>
                {reportComponents}
              </tbody>
              </table>
              <LineChartComponent reports={this.state.reports} />
             </div>
           )
        }
    }

    ReactDOM.render(
        <ReportList />,
        document.getElementById('root')
    )
  </script>
</html>
